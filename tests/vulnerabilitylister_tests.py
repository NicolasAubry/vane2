# Vane 2.0: A web application vulnerability assessment tool.
# Copyright (C) 2017-  Delve Labs inc.
#
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 2
# of the License.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.

from unittest import TestCase
from openwebvulndb.common.models import VulnerabilityList, Vulnerability, VersionRange

from vane.vulnerabilitylister import VulnerabilityLister


class TestVulnerabilityLister(TestCase):

    def setUp(self):
        self.vulnerability_lister = VulnerabilityLister()

    def test_list_vulnerabilities_return_empty_list_if_no_vuln_applicable_to_version(self):
        vuln0 = Vulnerability(id="12345", title="Vulnerability0",
                              affected_versions=[VersionRange(introduced_in="4.4", fixed_in="4.6")])
        vuln1 = Vulnerability(id="23456", title="Vulnerability1",
                              affected_versions=[VersionRange(fixed_in="3.9")])
        vuln_list = VulnerabilityList(key="wordpress", producer="producer", vulnerabilities=[vuln0, vuln1])

        applicable_vuln0 = self.vulnerability_lister.list_vulnerabilities("4.7", vuln_list)
        applicable_vuln1 = self.vulnerability_lister.list_vulnerabilities("4.3", vuln_list)

        self.assertEqual(len(applicable_vuln0), 0)
        self.assertEqual(len(applicable_vuln1), 0)

    def test_list_vulnerabilities_return_vulnerabilities_with_introduced_in_lower_than_version_and_fixed_in_upper_than_version(self):
        vuln0 = Vulnerability(id="12345", title="Vulnerability0",
                              affected_versions=[VersionRange(introduced_in="2.5.9", fixed_in="4.7.2")])
        vuln1 = Vulnerability(id="23456", title="Vulnerability1",
                              affected_versions=[VersionRange(introduced_in="1.6.2", fixed_in="4.9")])
        vuln_list = VulnerabilityList(key="wordpress", producer="producer", vulnerabilities=[vuln0, vuln1])

        applicable_vuln0 = self.vulnerability_lister.list_vulnerabilities("4.7", vuln_list)
        applicable_vuln1 = self.vulnerability_lister.list_vulnerabilities("3.5.8", vuln_list)
        applicable_vuln2 = self.vulnerability_lister.list_vulnerabilities("2.4.8", vuln_list)

        self.assertIn(vuln0, applicable_vuln0)
        self.assertIn(vuln1, applicable_vuln0)
        self.assertIn(vuln0, applicable_vuln1)
        self.assertIn(vuln1, applicable_vuln1)
        self.assertNotIn(vuln0, applicable_vuln2)
        self.assertIn(vuln1, applicable_vuln2)

    def test_list_vulnerabilities_return_vulnerabilities_with_no_introduced_in_if_fixed_in_is_upper_than_version(self):
        vuln0 = Vulnerability(id="12345", title="Vulnerability0",
                              affected_versions=[VersionRange(fixed_in="4.7.2")])
        vuln1 = Vulnerability(id="23456", title="Vulnerability1",
                              affected_versions=[VersionRange(fixed_in="4.9")])
        vuln_list = VulnerabilityList(key="wordpress", producer="producer", vulnerabilities=[vuln0, vuln1])

        applicable_vuln0 = self.vulnerability_lister.list_vulnerabilities("4.7", vuln_list)
        applicable_vuln1 = self.vulnerability_lister.list_vulnerabilities("4.8.2", vuln_list)

        self.assertIn(vuln0, applicable_vuln0)
        self.assertIn(vuln1, applicable_vuln0)
        self.assertNotIn(vuln0, applicable_vuln1)
        self.assertIn(vuln1, applicable_vuln1)

    def test_list_vulnerabilities_return_all_vulnerabilities_with_no_introduced_nor_fixed_in(self):
        vuln0 = Vulnerability(id="12345", title="Vulnerability0")
        vuln1 = Vulnerability(id="23456", title="Vulnerability1", affected_versions=[VersionRange()])
        vuln_list = VulnerabilityList(key="wordpress", producer="producer", vulnerabilities=[vuln0, vuln1])

        applicable_vuln0 = self.vulnerability_lister.list_vulnerabilities("4.7", vuln_list)
        applicable_vuln1 = self.vulnerability_lister.list_vulnerabilities("0.1", vuln_list)
        applicable_vuln2 = self.vulnerability_lister.list_vulnerabilities("100.2.3", vuln_list)

        self.assertIn(vuln0, applicable_vuln0)
        self.assertIn(vuln1, applicable_vuln0)
        self.assertIn(vuln0, applicable_vuln1)
        self.assertIn(vuln1, applicable_vuln1)
        self.assertIn(vuln0, applicable_vuln2)
        self.assertIn(vuln1, applicable_vuln2)

    def test_list_vulnerabilities_return_vulnerabilities_with_introduced_in_lower_than_version_if_no_fixed_in(self):
        vuln0 = Vulnerability(id="12345", title="Vulnerability0",
                              affected_versions=[VersionRange(introduced_in="2.3.4")])
        vuln1 = Vulnerability(id="23456", title="Vulnerability1",
                              affected_versions=[VersionRange(introduced_in="1.5.6")])
        vuln_list = VulnerabilityList(key="wordpress", producer="producer", vulnerabilities=[vuln0, vuln1])

        applicable_vuln0 = self.vulnerability_lister.list_vulnerabilities("4.7", vuln_list)
        applicable_vuln1 = self.vulnerability_lister.list_vulnerabilities("2.3.5", vuln_list)
        applicable_vuln2 = self.vulnerability_lister.list_vulnerabilities("1.7", vuln_list)

        self.assertIn(vuln0, applicable_vuln0)
        self.assertIn(vuln1, applicable_vuln0)
        self.assertIn(vuln0, applicable_vuln1)
        self.assertIn(vuln1, applicable_vuln1)
        self.assertNotIn(vuln0, applicable_vuln2)
        self.assertIn(vuln1, applicable_vuln2)

    def test_list_vulnerabilities_return_no_vulnerability_if_version_is_none(self):
        vuln0 = Vulnerability(id="12345", title="Vulnerability0",
                              affected_versions=[VersionRange(introduced_in="2.3.4")])
        vuln1 = Vulnerability(id="23456", title="Vulnerability1",
                              affected_versions=[VersionRange(introduced_in="1.5.6")])
        vuln_list = VulnerabilityList(key="wordpress", producer="producer", vulnerabilities=[vuln0, vuln1])

        applicable_vuln = self.vulnerability_lister.list_vulnerabilities(None, vuln_list)

        self.assertEqual(len(applicable_vuln), 0)

    def test_list_vulnerabilities_return_all_vulnerabilities_if_version_is_none_and_no_version_match_all_is_true(self):
        vuln0 = Vulnerability(id="12345", title="Vulnerability0",
                              affected_versions=[VersionRange(introduced_in="2.3.4")])
        vuln1 = Vulnerability(id="23456", title="Vulnerability1",
                              affected_versions=[VersionRange(introduced_in="1.5.6")])
        vuln_list = VulnerabilityList(key="wordpress", producer="producer", vulnerabilities=[vuln0, vuln1])

        applicable_vuln = self.vulnerability_lister.list_vulnerabilities(None, vuln_list, no_version_match_all=True)

        self.assertEqual(len(applicable_vuln), 2)

    def test_list_vulnerabilities_apply_vulnerabilities_with_multiple_affected_versions(self):
        vuln = Vulnerability(id="12345", title="Vulnerability", affected_versions=[
            VersionRange(introduced_in="3.7", fixed_in="3.7.5"), VersionRange(introduced_in="4.0", fixed_in="4.0.10"),
            VersionRange(introduced_in="4.5", fixed_in="4.5.2")])
        vuln_list = VulnerabilityList(key="wordpress", producer="producer", vulnerabilities=[vuln])

        vuln_software0 = self.vulnerability_lister.list_vulnerabilities("4.1.5", vuln_list)
        vuln_software1 = self.vulnerability_lister.list_vulnerabilities("4.0.9", vuln_list)

        self.assertEqual(vuln_software0, [])
        self.assertEqual(vuln_software1[0].id, vuln.id)

    def test_list_vulnerabilities_remove_affected_versions_ranges_not_including_target_version(self):
        vuln = Vulnerability(id="12345", title="Vulnerability", affected_versions=[
            VersionRange(introduced_in="3.7", fixed_in="3.7.5"), VersionRange(introduced_in="4.0", fixed_in="4.0.10"),
            VersionRange(introduced_in="4.5", fixed_in="4.5.2")])
        vuln_list = VulnerabilityList(key="wordpress", producer="producer", vulnerabilities=[vuln])

        vuln_software0 = self.vulnerability_lister.list_vulnerabilities("3.7.3", vuln_list)
        vuln_software1 = self.vulnerability_lister.list_vulnerabilities("4.0.9", vuln_list)
        vuln_software2 = self.vulnerability_lister.list_vulnerabilities("4.5", vuln_list)

        self.assertEqual(vuln_software0[0].affected_versions, [VersionRange(introduced_in="3.7", fixed_in="3.7.5")])
        self.assertEqual(vuln_software1[0].affected_versions, [VersionRange(introduced_in="4.0", fixed_in="4.0.10")])
        self.assertEqual(vuln_software2[0].affected_versions, [VersionRange(introduced_in="4.5", fixed_in="4.5.2")])
